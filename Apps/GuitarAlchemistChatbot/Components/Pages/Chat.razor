@page "/"
@inject IChatClient ChatClient
@inject NavigationManager Nav
@inject GuitarAlchemistFunctions Functions
@inject ConversationContextService ContextService
@inject IConfiguration Configuration
@inject IJSRuntime Js
@using System.Net
@using System.Text
@using System.Text.RegularExpressions
@implements IDisposable

<PageTitle>Guitar Alchemist Chat</PageTitle>

<div class="chat-container">
    <div class="chat-header">
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h1><i class="fas fa-guitar me-2"></i>Guitar Alchemist Chat</h1>
                <p class="text-muted mb-0">Ask me about chords, scales, music theory, and guitar techniques!</p>
            </div>
            <div class="d-flex gap-2 align-items-center">
                @if (!string.IsNullOrEmpty(_contextSummary))
                {
                    <div class="context-indicator" title="@_contextSummary">
                        <i class="fas fa-brain me-1"></i>
                        <small>@_contextSummary</small>
                    </div>
                }
                <a href="/models3d" class="btn btn-outline-info btn-sm">
                    <i class="fas fa-cube me-1"></i>3D Models
                </a>
                <button class="btn btn-outline-secondary btn-sm" @onclick="ResetConversationAsync">
                    <i class="fas fa-plus me-1"></i>New Chat
                </button>
                <button class="btn btn-outline-primary btn-sm" @onclick="ToggleAdminPanel">
                    <i class="fas fa-cog me-1"></i>Settings
                </button>
            </div>
        </div>

        @if (_showAdminPanel)
        {
            <div class="admin-panel mt-3">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0"><i class="fas fa-database me-2"></i>Vector Store Management</h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Status</h6>
                                <ul class="list-unstyled small">
                                    <li><strong>Mode:</strong> @(IsApiKeyConfigured ? "OpenAI" : "Demo (In-Memory)")
                                    </li>
                                    <li><strong>Indexed:</strong> @(_vectorStoreIndexed ? "✅ Yes" : "❌ No")</li>
                                    <li><strong>Documents:</strong> @_vectorStoreDocCount</li>
                                    @if (_vectorStoreLastIndexed.HasValue)
                                    {
                                        <li><strong>Last Indexed:</strong> @_vectorStoreLastIndexed.Value.ToString("g")
                                        </li>
                                    }
                                    <li><strong>Build Time:</strong> @GetBuildTimestamp()</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6>Actions</h6>
                                <button class="btn btn-sm btn-primary" @onclick="ReindexVectorStoreAsync"
                                        disabled="@_isReindexing">
                                    @if (_isReindexing)
                                    {
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                        <span>Reindexing...</span>
                                    }
                                    else
                                    {
                                        <i class="fas fa-sync me-1"></i>
                                        <span>Reindex Vector Store</span>
                                    }
                                </button>
                                @if (!string.IsNullOrEmpty(_reindexMessage))
                                {
                                    <div
                                        class="alert alert-@(_reindexSuccess ? "success" : "danger") alert-sm mt-2 mb-0">
                                        @_reindexMessage
                                    </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    <div id="chatMessages" class="chat-messages" @ref="_messagesContainer">
        @if (_messages.Count <= 1)
        {
            <div class="welcome-message">
                <div class="card">
                    <div class="card-body text-center">
                        <i class="fas fa-guitar fa-3x text-primary mb-3"></i>
                        <h4>Welcome to Guitar Alchemist!</h4>
                        <p class="text-muted">I'm your AI guitar assistant. I can help you with:</p>
                        @if (!IsApiKeyConfigured)
                        {
                            <div class="alert alert-info mt-2">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Demo Mode:</strong> Running locally with in-memory AI — no OpenAI key required.
                                <span class="d-block mt-1"><small class="text-muted">Optional:</small> You can
                                    <a href="https://platform.openai.com/account/api-keys" target="_blank">add an OpenAI API key</a>
                                    to try cloud models. The app works fully without it.</span>
                            </div>
                        }
                        <div class="row">
                            <div class="col-md-6">
                                <ul class="list-unstyled text-start">
                                    <li><i class="fas fa-search me-2"></i>Finding chords by description</li>
                                    <li><i class="fas fa-music me-2"></i>Chord progressions and theory</li>
                                    <li><i class="fas fa-graduation-cap me-2"></i>Music theory explanations</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled text-start">
                                    <li><i class="fas fa-lightbulb me-2"></i>Similar chord suggestions</li>
                                    <li><i class="fas fa-guitar me-2"></i>Guitar techniques</li>
                                    <li><i class="fas fa-question-circle me-2"></i>General music questions</li>
                                </ul>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted">Try asking: "Show me some dark jazz chords" or "What are
                                modes?"</small>
                        </div>
                    </div>
                </div>
            </div>
        }

        @foreach (var message in _messages.Skip(1)) // Skip system message
        {
            <div class="message @(message.Role == ChatRole.User ? "user-message" : "assistant-message")">
                <div class="message-content">
                    @if (message.Role == ChatRole.User)
                    {
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="message-text">
                            @((MarkupString)FormatMessage(message.Text ?? ""))
                        </div>
                    }
                    else
                    {
                        <div class="assistant-avatar">
                            <i class="fas fa-guitar"></i>
                        </div>
                        <div class="message-text">
                            @((MarkupString)FormatMessage(message.Text ?? ""))
                        </div>
                        <div class="message-actions">
                            <button class="btn btn-sm btn-link text-muted" title="Copy reply"
                                    @onclick="() => CopyToClipboard(message.Text ?? string.Empty)"><i
                                    class="fas fa-copy"></i></button>
                        </div>
                    }
                </div>
            </div>
        }

        @if (_currentFunctionCall != null)
        {
            <div class="message assistant-message">
                <div class="message-content">
                    <div class="assistant-avatar">
                        <i class="fas fa-cog fa-spin"></i>
                    </div>
                    <div class="message-text">
                        <div class="function-indicator">
                            <i class="fas fa-tools me-2"></i>
                            <strong>@_currentFunctionCall</strong>
                            <div class="spinner-border spinner-border-sm ms-2" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (_currentResponseMessage != null)
        {
            <div class="message assistant-message">
                <div class="message-content">
                    <div class="assistant-avatar">
                        <i class="fas fa-guitar"></i>
                    </div>
                    <div class="message-text">
                        @if (string.IsNullOrEmpty(_currentResponseMessage.Text))
                        {
                            <div class="typing-indicator">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        }
                        else
                        {
                            @((MarkupString)FormatMessage(_currentResponseMessage.Text))
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    @if (ShowSuggestions)
    {
        <div class="quick-suggestions">
            @foreach (var s in _quickSuggestions)
            {
                <button class="btn btn-primary suggestion-btn" @onclick="() => SendSuggestionAsync(s)"><i
                        class="fas fa-user me-2"></i>@s</button>
            }
        </div>
    }

    <div class="chat-input">
        <div class="input-group">
            <input @ref="_chatInput" @bind="_inputText" @onkeypress="HandleKeyPress"
                   class="form-control" placeholder="Ask about chords, scales, or music theory..."
                   disabled="@_isGenerating"/>
            @if (_isGenerating)
            {
                <button class="btn btn-outline-danger" title="Stop generating" @onclick="CancelGenerationAsync">
                    <i class="fas fa-stop"></i>
                </button>
            }
            else
            {
                <button class="btn btn-primary" @onclick="SendMessageAsync"
                        disabled="@string.IsNullOrWhiteSpace(_inputText)">
                    <i class="fas fa-paper-plane"></i>
                </button>
            }
        </div>
    </div>
</div>

@code {
    private readonly ChatOptions _chatOptions = new();
    private readonly List<ChatMessage> _messages = [];
    private CancellationTokenSource? _currentResponseCancellation;
    private ChatMessage? _currentResponseMessage;
    private string? _currentFunctionCall;
    private ElementReference _messagesContainer;
    private ElementReference _chatInput;
    private string _inputText = "";
    private bool _isGenerating;
    private string _contextSummary = "";

    // Admin panel state
    private bool _showAdminPanel;
    private bool _isReindexing;
    private bool _vectorStoreIndexed;
    private int _vectorStoreDocCount;
    private DateTime? _vectorStoreLastIndexed;
    private string _reindexMessage = "";
    private bool _reindexSuccess;

    private readonly string[] _quickSuggestions =
    [
        "Find a nice jazz progression",
        "Show a circle progression",
        "Suggest chord voicings for pop rock",
        "Explain the ii-V-I in jazz"
    ];

    private bool ShowSuggestions => _messages.Count <= 2 && !_isGenerating;

    private bool IsApiKeyConfigured => !string.IsNullOrEmpty(Configuration["OpenAI:ApiKey"]);

    protected override void OnInitialized()
    {
        // Add system prompt
        _messages.Add(new(ChatRole.System, _systemPrompt));

        // Configure AI function tools
        _chatOptions.Tools =
        [
            // Chord search functions
            AIFunctionFactory.Create(Functions.SearchChords),
            AIFunctionFactory.Create(Functions.FindSimilarChords),
            AIFunctionFactory.Create(Functions.GetChordDetails),

            // Music theory functions
            AIFunctionFactory.Create(Functions.ExplainMusicTheory),

            // Chord diagram functions
            AIFunctionFactory.Create(Functions.GetChordDiagram),
            AIFunctionFactory.Create(Functions.ListAvailableChordDiagrams),

            // Chord progression functions
            AIFunctionFactory.Create(Functions.GetProgressionTemplates),
            AIFunctionFactory.Create(Functions.SearchProgressionTemplates),
            AIFunctionFactory.Create(Functions.GetProgressionGenres),

            // Web integration functions
            AIFunctionFactory.Create(Functions.SearchWikipedia),
            AIFunctionFactory.Create(Functions.GetWikipediaSummary),
            AIFunctionFactory.Create(Functions.SearchMusicTheorySite),
            AIFunctionFactory.Create(Functions.GetLatestMusicLessons),
            AIFunctionFactory.Create(Functions.FetchMusicTheoryArticle)
        ];

        // Enable function invocation monitoring
        _chatOptions.ToolMode = ChatToolMode.Auto;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await _chatInput.FocusAsync();
        }

        // Auto-scroll to bottom
        await Task.Delay(50);
        await ScrollToBottomAsync();
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !e.ShiftKey && !_isGenerating && !string.IsNullOrWhiteSpace(_inputText))
        {
            await SendMessageAsync();
        }
    }

    private async Task SendMessageAsync()
    {
        if (_isGenerating || string.IsNullOrWhiteSpace(_inputText)) return;

        var userMessage = _inputText.Trim();
        _inputText = "";
        _isGenerating = true;

        try
        {
            // Add user message and track in context
            _messages.Add(new(ChatRole.User, userMessage));
            ContextService.AddUserQuery(userMessage);
            StateHasChanged();
            await ScrollToBottomAsync();

            // Start generating response
            _currentResponseCancellation = new CancellationTokenSource();
            _currentResponseMessage = new(ChatRole.Assistant, "");
            StateHasChanged();

            var responseText = "";
            await foreach (var update in ChatClient.GetStreamingResponseAsync(_messages, _chatOptions, _currentResponseCancellation.Token))
            {
                // Show function call indicator
                if (update.Contents != null)
                {
                    foreach (var content in update.Contents)
                    {
                        if (content is FunctionCallContent functionCall)
                        {
                            _currentFunctionCall = $"Calling {functionCall.Name}...";
                            StateHasChanged();
                            await Task.Delay(100); // Brief delay to show indicator
                        }
                    }
                }

                if (update.Text != null)
                {
                    _currentFunctionCall = null;
                    responseText += update.Text;
                    _currentResponseMessage = new(ChatRole.Assistant, responseText);
                    StateHasChanged();
                    await ScrollToBottomAsync();
                }
            }

            // Add final message
            if (!string.IsNullOrEmpty(responseText))
            {
                _messages.Add(new(ChatRole.Assistant, responseText));
            }

            // Update context summary
            _contextSummary = ContextService.GetContextSummary();
        }
        catch (OperationCanceledException)
        {
            // User cancelled
        }
        catch (Exception ex)
        {
            _messages.Add(new(ChatRole.Assistant, $"I encountered an error: {ex.Message}. Please try again."));
        }
        finally
        {
            _currentResponseMessage = null;
            _currentFunctionCall = null;
            _isGenerating = false;
            _currentResponseCancellation?.Dispose();
            _currentResponseCancellation = null;
            StateHasChanged();
            await _chatInput.FocusAsync();
        }
    }

    private async Task ResetConversationAsync()
    {
        _currentResponseCancellation?.Cancel();
        _messages.Clear();
        _messages.Add(new(ChatRole.System, _systemPrompt));
        _currentResponseMessage = null;
        _currentFunctionCall = null;
        _isGenerating = false;
        _inputText = "";

        // Clear conversation context
        ContextService.Clear();
        _contextSummary = "";

        StateHasChanged();
        await _chatInput.FocusAsync();
    }

    private async Task ScrollToBottomAsync()
    {
        try
        {
            await Task.Delay(10);
            await Js.InvokeVoidAsync("gaChat.scrollToBottom", "chatMessages");
        }
        catch
        {
            // Ignore scroll errors
        }
    }

    private string FormatMessage(string text)
    {
        if (string.IsNullOrEmpty(text)) return "";

        // VexTab rendering removed - library was not loading reliably from CDN
        var placeholders = new Dictionary<string, string>();
        var idx = 0;

        // Extract chord-diagram blocks and replace with rendered diagrams
        var chordFence = new Regex("```chord-diagram\\s*\\n([\\s\\S]*?)```", RegexOptions.IgnoreCase);
        text = chordFence.Replace(text, m =>
        {
            var code = m.Groups[1].Value.Trim();
            var id = $"__CHORDBLOCK_{idx++}__";
            var html = RenderChordDiagram(code);
            placeholders[id] = html;
            return id;
        });

        // Basic list support (- item or 1. item)
        var lines = text.Replace("\r\n", "\n").Split('\n');
        var sb = new StringBuilder();
        bool inUl = false, inOl = false;
        var numberRegex = new Regex(@"^\s*\d+\.\s+(.*)");
        foreach (var raw in lines)
        {
            var line = raw;
            if (line.TrimStart().StartsWith("- ") || line.TrimStart().StartsWith("* "))
            {
                if (!inUl)
                {
                    if (inOl)
                    {
                        sb.Append("</ol>");
                        inOl = false;
                    }

                    sb.Append("<ul>");
                    inUl = true;
                }

                var content = line.TrimStart().Substring(2);
                sb.Append("<li>").Append(content).Append("</li>");
                continue;
            }

            var m = numberRegex.Match(line);
            if (m.Success)
            {
                if (!inOl)
                {
                    if (inUl)
                    {
                        sb.Append("</ul>");
                        inUl = false;
                    }

                    sb.Append("<ol>");
                    inOl = true;
                }

                sb.Append("<li>").Append(m.Groups[1].Value).Append("</li>");
                continue;
            }

            if (inUl)
            {
                sb.Append("</ul>");
                inUl = false;
            }

            if (inOl)
            {
                sb.Append("</ol>");
                inOl = false;
            }

            sb.Append(WebUtility.HtmlEncode(line)).Append("<br>");
        }

        if (inUl) sb.Append("</ul>");
        if (inOl) sb.Append("</ol>");
        var html = sb.ToString();

        // Bold and italic
        html = Regex.Replace(html, @"\*\*(.*?)\*\*", "<strong>$1</strong>");
        html = Regex.Replace(html, @"\*(.*?)\*", "<em>$1</em>");

        // Replace placeholders with raw HTML blocks
        foreach (var kv in placeholders)
        {
            html = html.Replace(kv.Key, kv.Value);
        }

        return html;
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await Js.InvokeVoidAsync("gaChat.copyText", text);
        }
        catch
        {
        }
    }

    private async Task SendSuggestionAsync(string suggestion)
    {
        if (_isGenerating) return;
        _inputText = suggestion;
        await SendMessageAsync();
    }


    private async Task CancelGenerationAsync()
    {
        try
        {
            _currentResponseCancellation?.Cancel();
            if (!string.IsNullOrEmpty(_currentResponseMessage?.Text))
            {
                _messages.Add(new(ChatRole.Assistant, _currentResponseMessage!.Text!));
            }
        }
        finally
        {
            _currentResponseMessage = null;
            _isGenerating = false;
            StateHasChanged();
            await _chatInput.FocusAsync();
        }
    }


    private void ToggleAdminPanel()
    {
        _showAdminPanel = !_showAdminPanel;
        StateHasChanged();
    }

    private async Task ReindexVectorStoreAsync()
    {
        _isReindexing = true;
        _reindexMessage = "";
        StateHasChanged();

        try
        {
            // Simulate reindexing (in demo mode, this is just a simulation)
            await Task.Delay(2000);

            // Update stats
            _vectorStoreIndexed = true;
            _vectorStoreDocCount = 42; // Simulated document count
            _vectorStoreLastIndexed = DateTime.Now;
            _reindexSuccess = true;
            _reindexMessage = $"Successfully indexed {_vectorStoreDocCount} documents in 2.0s";
        }
        catch (Exception ex)
        {
            _reindexSuccess = false;
            _reindexMessage = $"Reindexing failed: {ex.Message}";
        }
        finally
        {
            _isReindexing = false;
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _currentResponseCancellation?.Cancel();
        _currentResponseCancellation?.Dispose();
    }

    private const string _systemPrompt = @"You are Guitar Alchemist, an expert AI assistant specializing in guitar, music theory, and chord knowledge. You provide comprehensive musical education and guidance.

Your expertise includes:
- Guitar chords, scales, and techniques
- Music theory (harmony, voice leading, chord progressions)
- Jazz, classical, rock, pop, and other musical styles
- Chord voicings and inversions
- Scale modes and their applications
- Songwriting and composition advice

When users ask about chords:
1. Use the SearchChords function for natural language queries like ""dark jazz chords"" or ""bright major chords""
2. Use FindSimilarChords to suggest alternatives to specific chords
3. Use GetChordDetails for specific chord information
4. Always provide practical context and musical examples
5. When presenting chord search results, format them clearly with their names, qualities, and characteristics

When explaining music theory:
- Use clear, accessible language
- Provide practical guitar applications
- Give examples from well-known songs when relevant
- Use the ExplainMusicTheory function for structured information

Communication style:
- Be encouraging, educational, and passionate about music
- Use markdown formatting for better readability (**bold**, *italic*)
- Present information in organized lists or tables when appropriate
- Always explain the musical context and practical applications
- Help users discover new sounds and understand the theory behind what they're playing

Remember: You're helping musicians grow and explore new musical possibilities through comprehensive music education!";

    private string RenderChordDiagram(string code)
    {
        try
        {
            // Parse the chord diagram data
            var lines = code.Split('\n');
            string? name = null, notes = null;
            int[]? frets = null, fingers = null;
            var startFret = 0;
            BarreInfo? barre = null;

            foreach (var line in lines)
            {
                var parts = line.Split(':', 2);
                if (parts.Length != 2) continue;

                var key = parts[0].Trim();
                var value = parts[1].Trim();

                switch (key.ToLower())
                {
                    case "name":
                        name = value;
                        break;
                    case "frets":
                        frets = value.Split(',').Select(int.Parse).ToArray();
                        break;
                    case "fingers":
                        fingers = value.Split(',').Select(int.Parse).ToArray();
                        break;
                    case "notes":
                        notes = value;
                        break;
                    case "startfret":
                        startFret = int.Parse(value);
                        break;
                    case "barre":
                        var barreParts = value.Split(',').Select(int.Parse).ToArray();
                        if (barreParts.Length == 3)
                        {
                            barre = new BarreInfo(barreParts[0], barreParts[1], barreParts[2]);
                        }

                        break;
                }
            }

            if (name == null || frets == null || frets.Length != 6)
            {
                return "<div class=\"chord-error\">Invalid chord diagram data</div>";
            }

            // Generate SVG for the chord diagram
            var svg = new StringBuilder();
            svg.Append("<div class=\"chord-diagram-container\">");
            svg.Append($"<div class=\"chord-diagram\" title=\"{WebUtility.HtmlEncode(name)}\">");
            svg.Append($"<div class=\"chord-name\">{WebUtility.HtmlEncode(name)}</div>");
            svg.Append("<svg width=\"140\" height=\"180\" viewBox=\"0 0 140 180\" class=\"chord-svg\">");

            // Nut or fret indicator
            if (startFret == 0)
            {
                svg.Append("<rect x=\"18\" y=\"28\" width=\"104\" height=\"4\" fill=\"#333\" />");
            }
            else
            {
                svg.Append($"<text x=\"10\" y=\"55\" font-size=\"12\" fill=\"#666\">{startFret}fr</text>");
            }

            // Frets
            for (var fret = 0; fret < 5; fret++)
            {
                var y = 30 + fret * 30;
                var strokeWidth = fret == 0 && startFret == 0 ? 3 : 1;
                svg.Append($"<line x1=\"20\" y1=\"{y}\" x2=\"120\" y2=\"{y}\" stroke=\"#666\" stroke-width=\"{strokeWidth}\" />");
            }

            // Strings
            for (var str = 0; str < 6; str++)
            {
                var x = 20 + str * 20;
                svg.Append($"<line x1=\"{x}\" y1=\"30\" x2=\"{x}\" y2=\"150\" stroke=\"#888\" stroke-width=\"1.5\" />");
            }

            // String labels
            var stringNames = new[] { "E", "A", "D", "G", "B", "E" };
            for (var str = 0; str < 6; str++)
            {
                var x = 20 + str * 20;
                svg.Append($"<text x=\"{x}\" y=\"170\" text-anchor=\"middle\" font-size=\"11\" fill=\"#666\">{stringNames[str]}</text>");
            }

            // Barre indicator if needed
            if (barre != null)
            {
                var y = 30 + (barre.Fret - startFret) * 30 - 15;
                var x1 = 20 + barre.FromString * 20;
                var x2 = 20 + barre.ToStringNum * 20;
                svg.Append($"<line x1=\"{x1}\" y1=\"{y}\" x2=\"{x2}\" y2=\"{y}\" stroke=\"#2196F3\" stroke-width=\"16\" stroke-linecap=\"round\" opacity=\"0.8\" />");
            }

            // Finger positions
            for (var str = 0; str < 6; str++)
            {
                var x = 20 + str * 20;
                var fret = frets[str];

                if (fret > 0)
                {
                    var displayFret = fret - startFret;
                    var y = 30 + displayFret * 30 - 15;
                    svg.Append($"<circle cx=\"{x}\" cy=\"{y}\" r=\"8\" fill=\"#2196F3\" stroke=\"#fff\" stroke-width=\"2\" />");

                    if (fingers != null && str < fingers.Length && fingers[str] > 0)
                    {
                        svg.Append($"<text x=\"{x}\" y=\"{y + 4}\" text-anchor=\"middle\" font-size=\"11\" font-weight=\"bold\" fill=\"#fff\">{fingers[str]}</text>");
                    }
                }
                else if (fret == 0)
                {
                    svg.Append($"<circle cx=\"{x}\" cy=\"18\" r=\"6\" fill=\"none\" stroke=\"#4CAF50\" stroke-width=\"2\" />");
                }
                else
                {
                    svg.Append($"<text x=\"{x}\" y=\"22\" text-anchor=\"middle\" font-size=\"16\" font-weight=\"bold\" fill=\"#f44336\">×</text>");
                }
            }

            svg.Append("</svg>");

            if (!string.IsNullOrEmpty(notes))
            {
                svg.Append($"<div class=\"chord-notes\"><small>{WebUtility.HtmlEncode(notes)}</small></div>");
            }

            svg.Append("</div></div>");

            return svg.ToString();
        }
        catch (Exception ex)
        {
            return $"<div class=\"chord-error\">Error rendering chord diagram: {WebUtility.HtmlEncode(ex.Message)}</div>";
        }
    }

    private string GetBuildTimestamp()
    {
        try
        {
            var assembly = typeof(Chat).Assembly;
            var buildDate = File.GetLastWriteTime(assembly.Location);
            return buildDate.ToString("yyyy-MM-dd HH:mm:ss");
        }
        catch
        {
            return "Unknown";
        }
    }

}
