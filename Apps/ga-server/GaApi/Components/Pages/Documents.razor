@page "/documents"
@using GaApi.Services
@using GaApi.GraphQL.Types
@inject MongoDbService MongoDb
@inject ISnackbar Snackbar

<PageTitle>Document Management - Guitar Alchemist</PageTitle>

<MudText Typo="Typo.h3" GutterBottom="true">
    <MudIcon Icon="@Icons.Material.Filled.Description" Class="mr-2"/>
    Document Management
</MudText>

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6">
    <MudTabPanel Text="All Documents" Icon="@Icons.Material.Filled.List">
        <MudGrid>
            <MudItem xs="12">
                <MudPaper Elevation="1" Class="pa-4 mb-4">
                    <MudGrid>
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="_searchText" Label="Search" Variant="Variant.Outlined"
                                          Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search"
                                          Immediate="true" DebounceInterval="300" OnDebounceIntervalElapsed="SearchDocuments"/>
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudSelect @bind-Value="_filterSourceType" Label="Source Type" Variant="Variant.Outlined">
                                <MudSelectItem Value="@("")">All Types</MudSelectItem>
                                <MudSelectItem Value="@("YouTube")">YouTube</MudSelectItem>
                                <MudSelectItem Value="@("PDF")">PDF</MudSelectItem>
                                <MudSelectItem Value="@("Markdown")">Markdown</MudSelectItem>
                                <MudSelectItem Value="@("Text")">Text</MudSelectItem>
                                <MudSelectItem Value="@("Web")">Web</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" md="3">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                                       StartIcon="@Icons.Material.Filled.Refresh" OnClick="LoadDocuments">
                                Refresh
                            </MudButton>
                        </MudItem>
                    </MudGrid>
                </MudPaper>
            </MudItem>

            <MudItem xs="12">
                @if (_loading)
                {
                    <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4"/>
                }
                else if (_documents == null || !_documents.Any())
                {
                    <MudAlert Severity="Severity.Info">No documents found. Upload a document to get started.</MudAlert>
                }
                else
                {
                    <MudTable Items="_documents" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true"
                              OnRowClick="@((TableRowClickEventArgs<ProcessedDocumentType> args) => ViewDocument(args.Item))">
                        <HeaderContent>
                            <MudTh>Title</MudTh>
                            <MudTh>Source Type</MudTh>
                            <MudTh>Quality Score</MudTh>
                            <MudTh>Processed At</MudTh>
                            <MudTh>Actions</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Title">
                                <MudText Typo="Typo.body2">@context.Title</MudText>
                                @if (!string.IsNullOrEmpty(context.Summary))
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Summary.Substring(0, Math.Min(100, context.Summary.Length))...</MudText>
                                }
                            </MudTd>
                            <MudTd DataLabel="Source Type">
                                <MudChip T="string" Size="Size.Small" Color="GetSourceTypeColor(context.SourceType)">
                                    @context.SourceType
                                </MudChip>
                            </MudTd>
                            <MudTd DataLabel="Quality Score">
                                @if (context.Metadata?.QualityScore != null)
                                {
                                    <MudRating ReadOnly="true" SelectedValue="@((int)Math.Round(context.Metadata.QualityScore.Value))" MaxValue="5" Size="Size.Small"/>
                                }
                            </MudTd>
                            <MudTd DataLabel="Processed At">
                                <MudText Typo="Typo.caption">@context.ProcessedAt.ToString("g")</MudText>
                            </MudTd>
                            <MudTd DataLabel="Actions">
                                <MudIconButton Icon="@Icons.Material.Filled.Visibility" Size="Size.Small" Color="Color.Primary"
                                               OnClick="@(() => ViewDocument(context))"/>
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" Size="Size.Small" Color="Color.Error"
                                               OnClick="@(() => DeleteDocument(context.Id))"/>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                }
            </MudItem>
        </MudGrid>
    </MudTabPanel>

    <MudTabPanel Text="Upload Document" Icon="@Icons.Material.Filled.Upload">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudPaper Elevation="1" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">Upload from URL</MudText>
                    <MudTextField @bind-Value="_uploadUrl" Label="URL" Variant="Variant.Outlined" FullWidth="true"
                                  Placeholder="https://www.youtube.com/watch?v=..." Class="mb-4"/>
                    <MudSelect @bind-Value="_uploadSourceType" Label="Source Type" Variant="Variant.Outlined" FullWidth="true" Class="mb-4">
                        <MudSelectItem Value="@("YouTube")">YouTube</MudSelectItem>
                        <MudSelectItem Value="@("Web")">Web Page</MudSelectItem>
                        <MudSelectItem Value="@("PDF")">PDF</MudSelectItem>
                    </MudSelect>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                               StartIcon="@Icons.Material.Filled.CloudUpload" OnClick="UploadFromUrl"
                               Disabled="_uploading">
                        @if (_uploading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                            <span>Uploading...</span>
                        }
                        else
                        {
                            <span>Upload</span>
                        }
                    </MudButton>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" md="6">
                <MudPaper Elevation="1" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">Upload Text Content</MudText>
                    <MudTextField @bind-Value="_uploadTitle" Label="Title" Variant="Variant.Outlined" FullWidth="true" Class="mb-4"/>
                    <MudTextField @bind-Value="_uploadContent" Label="Content" Variant="Variant.Outlined" FullWidth="true"
                                  Lines="10" Class="mb-4"/>
                    <MudSelect @bind-Value="_uploadTextSourceType" Label="Source Type" Variant="Variant.Outlined" FullWidth="true" Class="mb-4">
                        <MudSelectItem Value="@("Markdown")">Markdown</MudSelectItem>
                        <MudSelectItem Value="@("Text")">Plain Text</MudSelectItem>
                    </MudSelect>
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" FullWidth="true"
                               StartIcon="@Icons.Material.Filled.CloudUpload" OnClick="UploadTextContent"
                               Disabled="_uploading">
                        @if (_uploading)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                            <span>Uploading...</span>
                        }
                        else
                        {
                            <span>Upload</span>
                        }
                    </MudButton>
                </MudPaper>
            </MudItem>
        </MudGrid>
    </MudTabPanel>

    <MudTabPanel Text="Search" Icon="@Icons.Material.Filled.Search">
        <MudPaper Elevation="1" Class="pa-4">
            <MudText Typo="Typo.h6" GutterBottom="true">Semantic Search</MudText>
            <MudTextField @bind-Value="_semanticSearchQuery" Label="Search Query" Variant="Variant.Outlined" FullWidth="true"
                          Placeholder="Search for music theory concepts, techniques, progressions..." Class="mb-4"/>
            <MudButton Variant="Variant.Filled" Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Search" OnClick="PerformSemanticSearch"
                       Disabled="_searching">
                @if (_searching)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2"/>
                    <span>Searching...</span>
                }
                else
                {
                    <span>Search</span>
                }
            </MudButton>

            @if (_searchResults != null && _searchResults.Any())
            {
                <MudDivider Class="my-4"/>
                <MudText Typo="Typo.h6" GutterBottom="true">Search Results</MudText>
                <MudList T="string">
                    @foreach (var result in _searchResults)
                    {
                        <MudListItem T="string">
                            <MudText Typo="Typo.body1">@result.Title</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">@result.Summary</MudText>
                            <MudText Typo="Typo.caption">Relevance: @(result.Metadata?.QualityScore?.ToString("P0") ?? "N/A")</MudText>
                        </MudListItem>
                        <MudDivider/>
                    }
                </MudList>
            }
        </MudPaper>
    </MudTabPanel>

    <MudTabPanel Text="Unified Mode" Icon="@Icons.Material.Filled.ShapeLine">
        <MudGrid>
            <MudItem xs="12" md="6">
                <MudPaper Elevation="1" Class="pa-4">
                    <MudText Typo="Typo.h6" GutterBottom="true">Quick Unified Summary</MudText>
                    <MudText Typo="Typo.body2" Class="mb-2">
                        Enter pitch classes (0–11) for a set/mode and view unified descriptors (ICV, Prime, Forte, etc.).
                    </MudText>
                    <MudTextField @bind-Value="_unifiedInput" Label="Pitch Classes" Variant="Variant.Outlined" FullWidth="true"
                                  Placeholder="e.g., 0,2,4,5,7,9,11" Class="mb-3" />
                    <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Calculate"
                               OnClick="AnalyzeUnified">
                        Analyze
                    </MudButton>
                </MudPaper>
            </MudItem>

            @if (_unifiedDesc is not null)
            {
                <MudItem xs="12" md="6">
                    <MudPaper Elevation="1" Class="pa-4">
                        <MudText Typo="Typo.h6" GutterBottom="true">Unified Summary</MudText>
                        <MudSimpleTable Dense="true" Hover="true">
                            <tbody>
                            <tr>
                                <td><strong>Name:</strong></td>
                                <td>@_unifiedDesc.PrimaryName</td>
                            </tr>
                            <tr>
                                <td><strong>Summary:</strong></td>
                                <td>@_unifiedDesc.Summary</td>
                            </tr>
                            <tr>
                                <td><strong>ICV:</strong></td>
                                <td>@_unifiedDesc.IntervalClassVector</td>
                            </tr>
                            <tr>
                                <td><strong>Prime Form:</strong></td>
                                <td>@_unifiedDesc.PrimeForm</td>
                            </tr>
                            <tr>
                                <td><strong>Forte:</strong></td>
                                <td>@_unifiedDesc.ForteNumber</td>
                            </tr>
                            <tr>
                                <td><strong>Symmetry:</strong></td>
                                <td>@(_unifiedDesc.Symmetry ?? "—")</td>
                            </tr>
                            <tr>
                                <td><strong>Rotation:</strong></td>
                                <td>@_unifiedDesc.RotationIndex</td>
                            </tr>
                            <tr>
                                <td><strong>Family:</strong></td>
                                <td>@(_unifiedDesc.FamilyInfo ?? "None")</td>
                            </tr>
                            </tbody>
                        </MudSimpleTable>
                    </MudPaper>
                </MudItem>
            }
        </MudGrid>
    </MudTabPanel>
</MudTabs>

<MudDialog @bind-IsVisible="_showDocumentDialog" Options="_dialogOptions">
    <TitleContent>
        <MudText Typo="Typo.h6">@_selectedDocument?.Title</MudText>
    </TitleContent>
    <DialogContent>
        @if (_selectedDocument != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <MudChip T="string" Size="Size.Small" Color="GetSourceTypeColor(_selectedDocument.SourceType)">
                        @_selectedDocument.SourceType
                    </MudChip>
                    @if (_selectedDocument.Metadata?.QualityScore != null)
                    {
                        <MudRating ReadOnly="true" SelectedValue="@((int)Math.Round(_selectedDocument.Metadata.QualityScore.Value))" MaxValue="5" Size="Size.Small"/>
                    }
                </MudItem>
                <MudItem xs="12">
                    <MudText Typo="Typo.h6">Summary</MudText>
                    <MudText Typo="Typo.body2">@_selectedDocument.Summary</MudText>
                </MudItem>
                @if (_selectedDocument.ExtractedKnowledge != null)
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.h6">Extracted Knowledge</MudText>
                        @if (_selectedDocument.ExtractedKnowledge.ChordProgressions?.Any() == true)
                        {
                            <MudText Typo="Typo.subtitle2" Class="mt-2">Chord Progressions</MudText>
                            <MudChipSet T="string">
                                @foreach (var progression in _selectedDocument.ExtractedKnowledge.ChordProgressions)
                                {
                                    <MudChip Size="Size.Small">@progression</MudChip>
                                }
                            </MudChipSet>
                        }
                        @if (_selectedDocument.ExtractedKnowledge.Scales?.Any() == true)
                        {
                            <MudText Typo="Typo.subtitle2" Class="mt-2">Scales</MudText>
                            <MudChipSet T="string">
                                @foreach (var scale in _selectedDocument.ExtractedKnowledge.Scales)
                                {
                                    <MudChip Size="Size.Small">@scale</MudChip>
                                }
                            </MudChipSet>
                        }
                        @if (_selectedDocument.ExtractedKnowledge.Techniques?.Any() == true)
                        {
                            <MudText Typo="Typo.subtitle2" Class="mt-2">Techniques</MudText>
                            <MudChipSet T="string">
                                @foreach (var technique in _selectedDocument.ExtractedKnowledge.Techniques)
                                {
                                    <MudChip Size="Size.Small">@technique</MudChip>
                                }
                            </MudChipSet>
                        }
                    </MudItem>
                }
                <MudItem xs="12">
                    <MudText Typo="Typo.caption">Processed: @_selectedDocument.ProcessedAt.ToString("F")</MudText>
                </MudItem>
            </MudGrid>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="CloseDocumentDialog">Close</MudButton>
    </DialogActions>
</MudDialog>

